Mono AI Budget Bot
=================

Telegram-бот для аналітики витрат Monobank з контрольованою AI-надбудовою.

Ідея: бот підключається до Monobank Personal API (по токену користувача), синхронізує транзакції по обраним рахункам/карткам, рахує метрики за період (кодом) і формує звіт. AI (LLM) отримує лише агреговані “facts” (JSON) і генерує короткі інсайти та рекомендації, прив’язані до цифр.

Проєкт зроблений як тестове завдання на AI-інтернатуру: акцент на архітектурі, стабільності, безпеці, обмеженнях API, і “вау”-ефекті від AI без втрати контролю.


Що вміє (MVP)
-------------

1) Підключення Monobank
- /connect — додати Monobank token
- /status — перевірка доступу до Monobank (client-info / statement)

2) Вибір рахунків/карток
- /accounts (або аналогічна команда в твоїй реалізації) — обрати рахунки/картки для аналізу
- після вибору карток бот пропонує первинне завантаження історії (1 місяць або 3 місяці), далі — інкрементальні sync

3) On-demand звіти
- /today — витрати за сьогодні
- /week — витрати за останні 7 днів + порівняння з попередніми 7 днями
- /month — витрати за останні 30 днів (в межах 31d+1h API) + порівняння з попередніми 30 днями

4) Регулярні звіти
- weekly / monthly автозвіти в заданий час (через scheduler)
- refresh/sync у фоні, з локами, щоб один користувач не запускав кілька sync одночасно

5) Звіт містить (типова структура)
- Total spend (опційно income, якщо ввімкнеш)
- Transactions count
- Top categories / top merchants
- Outliers (“дивні” витрати)
- Breakdown by account (по картках)
- Compare with previous period
- AI insights: короткий підсумок + 3–7 конкретних рекомендацій, прив’язаних до цифр
- Next step: 1 наступний крок (звичка/ліміт/дія) на базі даних


AI частина: як це працює (важливо)
---------------------------------

Принцип: “Код рахує факти — LLM пише текст”.

1) Аналітика (код)
- збирає транзакції в ledger
- рахує метрики: totals, counts, топи, розбивки, порівняння періодів, outliers
- формує facts JSON (структуровані числа та списки)

2) Генерація інсайтів (LLM)
- LLM отримує facts JSON
- повертає: пояснення змін, рекомендації, next_step
- guardrails:
  - без інвестиційних порад
  - без медичних/юридичних порад
  - без “гарантій прибутку”
  - без вигаданих тверджень, які не випливають з facts

3) Failure mode
- якщо LLM недоступний / таймаут / помилка формату → бот не падає
- показує facts-репорт без AI (graceful fallback)


Monobank API: обмеження і як ми їх обходимо
------------------------------------------

Ключове обмеження Monobank Personal API:
- Rate limit: 1 request / 60 sec на client-info та statement
- Statement діапазон: максимум 31 доба + 1 година за один запит (для /month ок, довші періоди треба чанкувати)

Що робить бот:
- кешує відповіді/стан синхронізації
- використовує обережний throttling + retry/backoff при 429 (Too Many Requests)
- тримає per-user locks, щоб не створювати шторм запитів
- синхронізує інкрементально (оновлення по часу, з невеликим overlap, якщо потрібно)


Зберігання даних (локально до хостингу)
---------------------------------------

До деплою/хостингу дані зберігаються локально у директорії .cache:

- users: профіль користувача, налаштування, вибрані рахунки/картки
- token: monobank token (зашифрований)
- ledger: транзакції (JSONL) по user_id/account_id
- reports: кеш звітів (опційно)
- meta: технічний стан синхронізації (last sync timestamp, тощо)
- llm caches: кеш нормалізацій/профілю (опційно)

Як “очистити для чистого тесту”:
- видалити директорію .cache (або відповідну директорію storage)


Безпека і приватність
---------------------

- Monobank token зберігається ЗАШИФРОВАНИМ (через MASTER_KEY, fernet)
- В LLM (OpenAI) не відправляються сирі транзакції (raw statement)
- В LLM відправляються тільки агреговані facts JSON (суми, топи, метрики)
- Логи: технічні деталі без витоку токенів


Стек / технічні рішення
-----------------------

- Telegram bot framework: (aiogram або еквівалент)
- Scheduler: APScheduler (AsyncIOScheduler)
- Monobank API client + кеш/тротлінг
- Local storage: файловий (JSON/JSONL)
- Encryption: cryptography/fernet (MASTER_KEY)
- LLM: OpenAI API (Chat Completions), structured output (JSON)


Встановлення і запуск (локально)
--------------------------------

Варіант A (рекомендовано): через Poetry
1) Встановити залежності
- poetry install

2) Створити .env
Створи файл .env у корені і додай змінні (див. “ENV змінні”)

3) Запуск
- poetry run python -m <твій_пакет_бота>

Якщо є CLI entrypoint (наприклад monobot), то:
- poetry run monobot bot

Варіант B: без Poetry
- python -m venv .venv
- .venv/Scripts/activate (Windows) або source .venv/bin/activate (Linux/Mac)
- python -m <твій_пакет_бота>


ENV змінні (мінімальний набір)
------------------------------

TELEGRAM_BOT_TOKEN
- токен Telegram бота

OPENAI_API_KEY
- ключ OpenAI (можна не задавати: тоді бот має працювати у режимі facts-only)

MASTER_KEY
- ключ для шифрування токенів Monobank у storage
- формат: fernet key (base64)

Як згенерувати MASTER_KEY:
- python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

Додаткові (опційні):
- LOG_LEVEL=INFO
- TZ=Europe/Kyiv
- CACHE_DIR=.cache


Команди бота (користувацький гайд)
----------------------------------

Підключення:
- /connect
  1) бот просить токен Monobank
  2) після збереження токена — /status або /accounts

Перевірка:
- /status
  - показує чи токен валідний, чи API доступне

Вибір карток:
- /accounts
  - обрати рахунки/картки для аналізу
  - первинне завантаження: 1 місяць або 3 місяці
  - далі — інкрементальні оновлення

Звіти:
- /today
- /week
- /month

Автозвіти:
- /weekly (або команда/налаштування у твоїй реалізації)
- /monthly

Довільні запити (NLQ):
- користувач може написати текстом, наприклад:
  - “Скільки я за останні 15 днів витратив на Макдональдс?”
  - “Топ-5 категорій за 30 днів”
  - “Скільки транзакцій за тиждень?”
Бот:
- класифікує intent+slots (allowlist)
- виконує запит по ledger
- дає коротку відповідь


Демо (для інтернатури)
----------------------

- docs/demo/connect.png
- docs/demo/accounts.png
- docs/demo/week.png
- docs/demo/nlq.png


Статус проєкту
--------------

MVP фокус:
- стабільна синхронізація під rate limit
- коректні weekly/monthly порівняння
- AI інсайти з guardrails + fallback
- NLQ запити (швидкі відповіді) з allowlist
- зрозумілий README і “готовий вигляд” репозиторію


Roadmap (після здачі)
---------------------

Хостинг (Cloudflare):
- storage interface (local vs persistent)
- Cloudflare Workers runtime
- D1/KV для users/ledger/reports/caches
- global refresh кожні 2–3 години без 429-шторму
- async http + async rate limit

Полірування:
- краща деталізація MCC та кастомні категорії
- складніший outliers (звички/аномалії)
- більше NLQ інтентів (topN, compare periods, by card)
- merchant/category normalization (кеш)
- templates для UI, інлайн-кнопки, налаштування автозвітів
- структуровані логи та метрики